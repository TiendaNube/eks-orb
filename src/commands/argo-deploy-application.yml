description: |
  Generate an ArgoCD Application from a Helm chart.

parameters:
  release-name:
    type: string
  values-file:
    type: string
  namespace:
    type: string
  image-tag:
    type: string
  args:
    type: string
  mesh:
    type: boolean
  destination-server:
    type: string
  project:
    type: string
  set-path-annotation:
    type: string
  s3-chart-repo:
    type: string
  helm-app-status-timeout:
    type: string
  rollout-status-timeout:
    type: string
  rollout-status:
    type: boolean
  check-valid-previous-status:
    type: boolean
    default: true
  # Parameters for ArgoCD Application migration
  old-school-chart-file:
    description: The file name of the chart used before migrating
    type: string
  chart-version:
    description: Version/branch of the Helm chart to use
    type: string
    default: master

steps:
  - run:
      name: Compute ArgoCD Application parameters from Helm chart
      command: |
        echo "------------------------------------------------------"
        ARGO_PARAMETERS_DIR=/tmp/argo-parameters
        PARAMETERS_CHART_DIR=$ARGO_PARAMETERS_DIR/parameter-chart
        OLD_SCHOOL_CHART_NAME=$(cat << parameters.old-school-chart-file >>)
        mkdir -p "$ARGO_PARAMETERS_DIR"
        # Clean any previous files
        rm -f "$ARGO_PARAMETERS_DIR"/* 2>/dev/null || true
        ARGS='<< parameters.args >>'
        SANITIZED_ARGS=$(printf '%s\n' "$ARGS" | sed '/^[[:space:]]*--values[[:space:]]/d' | tr '\n' ' ' | sed -E 's/\\[[:space:]]+/ /g; s/[[:space:]]+/ /g; s/^[[:space:]]*//; s/[[:space:]]*$//')
        echo "ðŸ“„ Environment already set up for this step"
        echo "------------------------------------------------------"
        # Create directory structure for the chart
        mkdir -p $PARAMETERS_CHART_DIR/templates
        # Create Chart.yaml
        cat \<< EOF > $PARAMETERS_CHART_DIR/Chart.yaml
        apiVersion: v2
        name: parameter-chart
        description: Chart to visualize parameters
        type: application
        version: 0.1.0
        appVersion: "1.0.0"
        EOF
        # Create empty values.yaml
        echo "# Default values" > $PARAMETERS_CHART_DIR/values.yaml
        # Create template that will just output parameters
        cat \<< 'EOF' > $PARAMETERS_CHART_DIR/templates/parameters.yaml
        {{- define "formatValue" -}}
        {{- $sentinelDollarEscaped := "::DOLLAR_ESCAPED::" -}}
        {{- $sentinelNewlineEscaped := "::NEWLINE_ESCAPED::" -}}
        {{- $value := . -}}
        {{- if or (kindIs "bool" $value) (or (hasPrefix "int" (kindOf $value)) (hasPrefix "float" (kindOf $value))) }}
        value: {{ $value }}
        {{- else }}
        value: {{ $value | replace "$$" $sentinelDollarEscaped | replace "$" "$$" | replace $sentinelDollarEscaped "$$" | replace "\\n" $sentinelNewlineEscaped | quote }}
        forceString: true
        {{- end }}
        {{- end -}}
        {{- define "flatten" -}}
        {{- $root := index . 0 -}}
        {{- $prefix := index . 1 -}}
        {{- range $k, $v := $root }}
        {{- $name := "" -}}
        {{- if eq $prefix "" -}}
        {{- $name = $k -}}
        {{- else -}}
        {{- $name = printf "%s.%s" $prefix ($k | replace "." "\\.")  -}}
        {{- end -}}
        {{- if kindIs "map" $v }}
        {{- include "flatten" (list $v $name) }}
        {{- else if kindIs "slice" $v }}
        {{- range $i, $item := $v }}
        - name: {{ $name }}[{{ $i }}]
        {{- include "formatValue" $item | nindent 2 }}
        {{- end }}
        {{- else }}
        - name: {{ $name }}
        {{- include "formatValue" $v | nindent 2 }}
        {{- end }}
        {{- end }}
        {{- end }}
        parameters:
        {{- include "flatten" (list .Values "") | nindent 2 -}}
        EOF
        ARGO_PARAMETERS_FILE="$ARGO_PARAMETERS_DIR/parameters.yaml"
        ARGO_PARAMETERS_RAW_FILE="$ARGO_PARAMETERS_DIR/raw-parameters.yaml"
        # Generate template output with all values
        HELM_COMMAND="helmv3 template \
          parameter-chart \"\$PARAMETERS_CHART_DIR\" \
          $SANITIZED_ARGS \
          --set-string image.tag=\"<< parameters.image-tag >>\" \
          --set mesh=<< parameters.mesh >> \
          --set-string global.profile=\"\$PROFILE_NAME\" \
          --set-string canaryMigrationPhaseOverride=\"\$CANARY_MIGRATION_PHASE\" \
          --set-string previousChartName=\"\$OLD_SCHOOL_CHART_NAME\""
        eval "$HELM_COMMAND" > "$ARGO_PARAMETERS_RAW_FILE"
        echo "------------------------------------------------------"
        echo "ðŸ“Š Parameters:"
        echo "------------------------------------------------------"
        # Extract only the parameters section onwards, skipping warnings
        sed -n '/^parameters:/,$p' "$ARGO_PARAMETERS_RAW_FILE" | sed 's/::NEWLINE_ESCAPED::/\\\\\\\\n/g' > "${ARGO_PARAMETERS_FILE}"
        cat "${ARGO_PARAMETERS_FILE}"
        echo "------------------------------------------------------"

  - run:
      name: Add Github repository to ArgoCD
      environment:
        PROJECT: << parameters.project >>
        ARGO_CLI_COMMON_SCRIPT: << include(scripts/argo_cli_common.sh) >>
      command: << include(scripts/argo_add_repository.sh) >>

  - run:
      name: Create ArgoCD Application manifest
      command: |
        # Compute CHART_VERSION from parameter or auto-detect from cluster
        USER_CHART_VERSION="<< parameters.chart-version >>"
        if [[ -n "$USER_CHART_VERSION" ]]; then
          CHART_VERSION="$USER_CHART_VERSION"
        elif [[ "$PROFILE_NAME" == *"staging"* ]]; then
          CHART_VERSION="staging"
        else
          CHART_VERSION="master"
        fi
        # Set up directories and file paths
        ARGO_PARAMETERS_DIR=/tmp/argo-parameters
        ARGO_APP_VALUE_FILE="$ARGO_PARAMETERS_DIR/argocd-app-values.yaml"
        ARGO_PARAMETERS_FILE="$ARGO_PARAMETERS_DIR/parameters.yaml"
        # Load and indent parameters from previous step
        PARAMETERS=$(cat "$ARGO_PARAMETERS_FILE")
        PARAMETERS_INDENTED=$(echo "$PARAMETERS" | awk 'NR==1{print $0; next} {print "      "$0}')
        # Extract additional value files from helm args
        HELM_VALUES_FILES='<< parameters.args >>'
        VALUES_FILES=()
        while [[ "$HELM_VALUES_FILES" =~ --values[[:space:]]+([^[:space:]\\]+) ]]; do
          VALUES_FILES+=("${BASH_REMATCH[1]}")
          HELM_VALUES_FILES="${HELM_VALUES_FILES/${BASH_REMATCH[0]}/}"
        done
        ADDITIONAL_VALUE_FILES=""
        if [[ ${#VALUES_FILES[@]} -gt 0 ]]; then
          for values_file in "${VALUES_FILES[@]}"; do
            ADDITIONAL_VALUE_FILES+=$'\n'"        - \"\$values/${values_file}\""
          done
        fi
        # Generate ArgoCD Application manifest
        cat \<< EOF > $ARGO_APP_VALUE_FILE
        argocd:
          namespace: argocd

        destination:
          namespace: << parameters.namespace >>
          server: << parameters.destination-server >>

        sources:
          - path: microservices-v8
            name: main-helm-chart
            repoURL: https://github.com/TiendaNube/helm-charts
            targetRevision: ${CHART_VERSION}
            helm:
              valueFiles:
                - "\$values/<< parameters.values-file >>"$ADDITIONAL_VALUE_FILES
              $PARAMETERS_INDENTED
          - repoURL: "${REPOSITORY_HTTP_URL}"
            name: "${CIRCLE_PROJECT_REPONAME}"
            targetRevision: "${CIRCLE_SHA1}"
            ref: values

        project: << parameters.project >>

        info:
          - name: "github.repository"
            value: "${REPOSITORY_HTTP_URL}"

        syncPolicy:
          automated:
            enabled: true
            prune: true
            selfHeal: true
          syncOptions:
            applyOutOfSyncOnly: true
            createNamespace: true
            pruneLast: true
            validate: true
            replace: false

        ignoreDifferences:
          # Ignore differences in the Ingress spec as Argo Rollouts will add the canary-header-route rules to enable canary rollouts
          - group: networking.k8s.io
            kind: Ingress
            jqPathExpressions:
              - ".spec.rules[]?.http.paths[]? | select(.backend.service.name == \"canary-header-route\")"
          # Ignore differences in the ServiceAccount annotations as some of them are created by Terraform when an IAM role is needed
          - group: ""
            kind: ServiceAccount
            jqPathExpressions:
              - ".metadata.annotations[\"eks.amazonaws.com/role-arn\"]"
        EOF
        # Print generated manifest
        echo "------------------------------------------------------"
        echo "ðŸ“„ ArgoCD Application manifest:"
        echo "------------------------------------------------------"
        cat $ARGO_APP_VALUE_FILE
        echo "------------------------------------------------------"

  - when:
      condition: << parameters.check-valid-previous-status >>
      steps:
        - argo-app-previous-status:
            release-name: << parameters.release-name >>

  - run:
      name: Upsert Argo Application
      command: |
        ARGO_PARAMETERS_DIR=/tmp/argo-parameters
        ARGO_APP_VALUE_FILE="$ARGO_PARAMETERS_DIR/argocd-app-values.yaml"
        helmv3 upgrade \
          --create-namespace \
          --install \
          << parameters.release-name >>-app \
          --values << parameters.values-file >> \
          --values $ARGO_APP_VALUE_FILE \
          --namespace << parameters.namespace >> \
          <<#parameters.args>><<parameters.args>><</parameters.args>> \
          << parameters.s3-chart-repo >>/argocd-apps

  - helm-status:
      release-name: << parameters.release-name >>-app
      namespace: << parameters.namespace >>
      timeout: << parameters.helm-app-status-timeout >>

  - when:
      condition: << parameters.rollout-status >>
      steps:
        - argo-rollout-status:
            timeout: << parameters.rollout-status-timeout >>
